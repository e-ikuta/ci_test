version: 2.1

defaults: &defaults
  docker:
    - image: cimg/base:2021.04

commands:
  set_env:
    steps:
      - run:
          name: set environment
          command: . .circleci/set_env.sh

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - set_env
      - run:
          name: build
          command: echo build CIRCLE_TAG ${CIRCLE_TAG}
  deploy_to_stg:
    <<: *defaults
    steps:
      - checkout
      - set_env
      - run:
          name: deploy
          command: echo deploy to stg CIRCLE_TAG ${CIRCLE_TAG}
  deploy_to_prd:
    <<: *defaults
    steps:
      - checkout
      - set_env
      - run:
          name: deploy
          command: echo deploy to prd CIRCLE_TAG ${CIRCLE_TAG} CIRCLE_BRANCH ${CIRCLE_BRANCH}

workflows:
  deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^release_[0-9]+$/
      - deploy_to_stg:
          requires:
            - build
      - approval:
           type: approval
           requires:
             - build
           filters:
             tags:
               only: /^release_[0-9]+$/
             branches:
               ignore: /.*/
      - deploy_to_prd:
          requires:
            - approval
          filters:
            tags:
              only: /^release_[0-9]+$/
            branches:
              ignore: /.*/
