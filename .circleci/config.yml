version: 2.1

defaults: &defaults
  docker:
    - image: cimg/base:2021.04

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: build
          command: echo build CIRCLE_TAG ${CIRCLE_TAG}
  deploy_to_stg:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: deploy
          command: echo deploy to stg CIRCLE_TAG ${CIRCLE_TAG}
  deploy_to_prd:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: deploy
          command: echo deploy to prd CIRCLE_TAG ${CIRCLE_TAG}

workflows:
  deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^release_[0-9]+$/
      - deploy_to_stg:
          requires:
            - build
      - deploy_to_prd:
          requires:
            - build
          filters:
            tags:
              only: /^release_[0-9]+$/
            branches:
              ignore: /.*/
